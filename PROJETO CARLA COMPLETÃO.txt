Carla ‚Äî Bot de Vendas no WhatsApp (FSM Blindada)
Vendedora virtual emp√°tica e persuasiva integrada ao WhatsApp via Baileys, com fluxos de conversa (FSM) orientados a convers√£o, telemetria de funil, sess√£o persistente no Railway e prontinha para clonar em novas personas.
________________________________________
üì¶ Estrutura do Projeto
src/
  bot.js                # orquestra FSM e guarda‚Äëchuva de intents/guardrails
  model.js              # wrapper do provedor de IA (chat)
  telemetry.js          # eventos do funil (JSON/console)
  memory.js             # mem√≥ria leve por user (TTL)
  prompts/
    base.js             # persona + style rules + productPrompt
  flows/
    greet.js            # abertura calorosa (2 frases + 1 pergunta)
    qualify.js          # mapeia tipo de cabelo/dor (SEM loops)
    offer.js            # oferta curta, benef√≠cios, urg√™ncia (sem link)
    close.js            # s√≥ envia link com inten√ß√£o clara + p√≥s‚Äëvenda
    postsale.js         # confirma comprovante, agradece e libera cupom
public/
  product.jpg           # foto do produto exibida na primeira intera√ß√£o
.env.example            # vari√°veis de ambiente (modelo)
________________________________________
üîß Requisitos
‚Ä¢	Node 18.x (Baileys est√°vel) ‚Äî recomenda‚Äëse NVM
‚Ä¢	Conta WhatsApp dedicada
‚Ä¢	Git + GitHub
‚Ä¢	(Prod) Conta Railway com volume persistente
________________________________________
‚öôÔ∏è Vari√°veis de Ambiente (.env)
Crie um .env na raiz do projeto:
OPENAI_API_KEY=coloque_sua_chave_aqui
MODEL_NAME=gpt-4o
PRICE_TARGET=170
PRICE_ORIGINAL=197
WPP_AUTH_DIR=./.wpp-auth
MEMORY_TTL_DAYS=7
PORT=8080
CHECKOUT_LINK=https://entrega.logzz.com.br/pay/memmpxgmg/progcreme170
COUPON_CODE=TOP-AGO2025-PROGRVG-150
Railway (produ√ß√£o): use WPP_AUTH_DIR=/app/baileys-auth e monte um volume nesse caminho.
________________________________________
‚ñ∂Ô∏è Rodando Localmente
nvm use 18
npm install
mkdir .wpp-auth  # guarda a sess√£o do WhatsApp localmente
npm start
Parear WhatsApp: abra http://127.0.0.1:8080/wpp/qr e escaneie o QR pelo app (Dispositivos Conectados). A sess√£o fica salva e n√£o precisa repetir.
Health check: curl http://127.0.0.1:8080/health ‚Üí { "ok": true }
Teste de webhook:
curl -X POST "http://127.0.0.1:8080/webhook" \
  -H "Content-Type: application/json" \
  -d '{"userId":"c001","text":"Oi, Carla!","context":{}}'
________________________________________
üöÄ Deploy no Railway (produ√ß√£o)
1)	Conecte o repo do GitHub.
2)	Variables (Settings ‚Üí Variables):
OPENAI_API_KEY=...
MODEL_NAME=gpt-4o
PRICE_TARGET=170
PRICE_ORIGINAL=197
WPP_AUTH_DIR=/app/baileys-auth
MEMORY_TTL_DAYS=7
PORT=8080
CHECKOUT_LINK=...
COUPON_CODE=...
3)	Persistent Storage / Volumes ‚Üí Add Volume
‚Ä¢	Mount path: /app/baileys-auth
4)	Deploy autom√°tico pela main.
Health (prod): curl https://<SEU-APP>.up.railway.app/health
Webhook (prod):
curl -X POST "https://<SEU-APP>.up.railway.app/webhook" \
  -H "Content-Type: application/json" \
  -d '{"userId":"c001","text":"Oi, Carla!","context":{}}'
________________________________________
üß† FSM (Fluxo de Conversa)
1) greet - Abertura em at√© 2 frases + 1 pergunta - Pede nome e registra em memory - Empatia + valida√ß√£o emocional + tom humano
2) qualify - Pergunta uma vez o tipo de cabelo caso ainda n√£o saiba - Se j√° souber, mapeia dor (frizz, volume, chapinha, defini√ß√£o) - Sem loops, sem repeti√ß√£o
3) offer - Sempre inclui: R$197 ‚Üí R$170, COD (paga na entrega), prazo (24h capitais; 2 dias), urg√™ncia (estoque limitado) - Personaliza benef√≠cio por tipo de cabelo - Sem link nesta etapa - Trata d√∫vida vaga (‚Äún√£o sei‚Ä¶ ser√° que‚Ä¶‚Äù) como obje√ß√£o leve
4) close - S√≥ envia link se houver inten√ß√£o clara (comprar/checkout/fechar pedido) - D√∫vidas informativas: responde sem link - P√≥s‚Äëvenda: ao detectar comprovante, agradece e libera cupom
5) postsale - Confirma comprovante, agradece e envia COUPON_CODE - Encerramento com 1 pergunta leve (ex.: aviso de sa√≠da para entrega)
________________________________________
üìä Telemetria (eventos)
‚Ä¢	session_start, midia_detectada, resposta_direta, erro
‚Ä¢	abertura_enviada (greet)
‚Ä¢	mapeamento_pergunta_enviada / dor_pergunta_enviada (qualify)
‚Ä¢	oferta_mostrada (offer)
‚Ä¢	checkout_enviado, pos_pagamento_enviado, cupom_liberado (close/postsale)
Use esses eventos para achar gargalos: onde os leads somem? oferta? fechamento? ajuste mensagens por etapa.
________________________________________
üß± Guardrails
‚Ä¢	N√£o revelar identidade t√©cnica (nada de ‚Äúsou IA‚Äù).
‚Ä¢	Link apenas no close com inten√ß√£o clara.
‚Ä¢	Pedir resumo em texto quando receber m√≠dia.
‚Ä¢	Respeitar 2 frases + 1 pergunta e 1 pergunta √∫nica (sem interrogat√≥rio).
________________________________________
üß™ Roteiro de Testes (checklist r√°pido)
1.	/health OK local e prod
2.	QR exibido em /wpp/qr e sess√£o conectada (persist√™ncia ok)
3.	greet pede nome (sem 2 perguntas)
4.	qualify pergunta tipo de cabelo s√≥ 1x e depois mapeia dor
5.	offer com pre√ßo, COD, prazo, urg√™ncia e sem link
6.	close envia link apenas com inten√ß√£o (simular ‚Äúquero comprar‚Äù)
7.	postsale reconhece comprovante e libera cupom
8.	Telemetria registrando os eventos acima
________________________________________
üõ†Ô∏è Git Workflow
Fluxo r√°pido (solo):
git add .
git commit -m "feat(flow): FSM blindada + telemetria"
git push origin main
Fluxo seguro (evita conflito):
git checkout main
git pull --rebase origin main
git add -A
git commit -m "feat: ajustes flows e guardrails"
git push origin main
________________________________________
‚ùì Troubleshooting
QR n√£o aparece - Confirme npm start sem erros - Atualize /wpp/qr a cada 2‚Äì3s - Verifique Node 18 via node -v
Cai a sess√£o no Railway - Garanta WPP_AUTH_DIR=/app/baileys-auth e volume montado nesse path
Respostas repetitivas/loops - Confirme que est√° usando os flows blindados (greet/qualify/offer/close/postsale) - Cheque env MODEL_NAME, PRICE_TARGET e logs da telemetry
Link saindo antes da hora - Revise close.js: s√≥ envia link quando shouldOfferLink() detectar inten√ß√£o
________________________________________
üß¨ Clonar para nova persona
1)	Duplicar pasta da Carla
2)	Ajustar prompts/base.js (persona + estilo)
3)	Atualizar productPrompt (nome, pre√ßo, claims, foto)
4)	Manter guardrails, telemetria e FSM
5)	Subir nova inst√¢ncia (n√∫mero pr√≥prio)
________________________________________
üìÑ Licen√ßa
Uso interno da TopOfertas Express. Ajuste conforme necessidade.
